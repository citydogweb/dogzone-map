<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../google-map/google-map.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../paper-material/paper-material.html">

<!-- all used icons to not load full iconsets -->
<link rel="import" href="map-iconset-svg.html">

<!--
An element providing a map of all dog parks in Vienna.

Example:

    <dogzone-map></dogzone-map>

@demo

-->
<dom-module id="dogzone-map">

  <style>
    :host {
      position: relative;
      display: block;
      height: 100%;
    }

    paper-fab.amber {
      position: absolute;
      top: 24px;
      right: 24px;
      --paper-fab-background: var(--paper-amber-500);
      --paper-fab-keyboard-focus-background: var(--paper-amber-900);
    }

    h2 {
      color: #262626;
    }

    h4 {
      color: #505050;
    }

    h5 {
      color: #616161;
    }

    #map {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
    }

    #infocontainer {
      /*background-color: #FFF8E1;*/
      background-color: white;
      position: absolute;
      padding: 6px;
      height: 80%;
      width: 28%;
      right: 32px;
      bottom: 10%;
    }

    #infomap {
      padding: 6px;
      height: 55%;
    }

    #infocontent {
      padding-left: 24px;
      height: 35%;
    }

    #satmap {
      height: 100%;
      width: 100%;
    }
  </style>

  <template>
    <iron-ajax auto url="http://data.wien.gv.at/daten/geo/" params='{"service":"WFS", "request":"getFeature", "version":"1.1.0", "typeName":"ogdwien:HUNDEZONEOGD", "srsName":"EPSG:4326", "outputFormat":"json"}' handleAs="json" on-response="_handleParks" on-error="handleParkError"></iron-ajax>
    <google-map id="map" disable-default-ui fit-to-markers click-events on-google-map-click="_handleMapClick" click-events>
      <template is="dom-repeat" items="{{coords}}" as="coord">
        <google-map-marker latitude="{{coord.geometry.coordinates.1}}" longitude="{{coord.geometry.coordinates.0}}" title="{{coord.properties.PARK}}" icon="{{parkIconUrl}}" on-google-map-marker-click="_handleClick" click-events>
        </google-map-marker>
      </template>
    </google-map>
    <!-- <paper-fab id="fab" mini icon="menu" class="amber" on-click="handleMenu"></paper-fab> -->
    <paper-material id="infocontainer" elevation="5" hidden="true">
      <div id="infomap">
        <google-map id="satmap" disable-default-ui map-type="satellite" zoom="18">
        </google-map>
      </div>
      <div id="infocontent">
        <h2>
          <p id="pname">{{selectedPark.properties.PARK}}</p>
        </h2>
        <h4>
          <p>
            <!-- <span>Typ: </span> -->
            <span>{{selectedPark.properties.TYP}}</span>
          </p>
        </h4>
        <h5>
          <p>
            <span>Fl√§che: </span>
            <span>{{selectedPark.properties.FLAECHE}}</span>
          </p>
          <p>
            <span>Einfriedung: </span>
            <span>{{selectedPark.properties.EINFRIEDUNG}}</span>
          </p>
          <p>
            <span>geo:(</span>
            <span>{{selectedPark.geometry.coordinates.1}}</span>
            <span> / </span>
            <span>{{selectedPark.geometry.coordinates.0}}</span>
            <span>)</span>
          </p>
        </h5>
      </div>
      <paper-fab id="fab" mini icon="map-iconset-svg:close" class="amber" on-click="_handleClose"></paper-fab>
    </paper-material>
    <!-- <paper-fab id="delete" mini icon="map-iconset-svg:close" class="amber" on-click="handleDelete"></paper-fab> -->
  </template>
</dom-module>

<script>
  Polymer({
    is: 'dogzone-map',

    properties: {

      /**
       * A custom icon path for map markers
       */
      parkIconUrl: {
        type: String,
        // value: '../dog.png'
        value: 'https://raw.githubusercontent.com/citydogweb/dogzone-map/master/dog_map_icon.png'
      },

      /**
       * A Object of the currently selected park
       */
      selectedPark: {
        type: Object,
        value: function() {
          return {};
        }
      },

      /**
       * Coordinates of dog parks
       */
      coords: {
        type: Array
          // notify: true
          // value: function() {
          //   return {};
          // }
      }
    },

    ready: function() {},

    _handleParks: function(event, response) {
      this.coords = response.response.features;
    },

    _handleMapClick: function(event) {
      this.$.infocontainer.hidden = true;
    },

    _handleClose: function(event) {
     this.$.infocontainer.hidden = true;
    },

    _handleClick: function(marker) {
      //get index from marker and use it to get park-node from COORDS(ajax-response)
      this.selectedPark = this.coords[marker.model.__data__.index];
      this.$.infocontainer.hidden = false;
      this.$.satmap.longitude = marker.target.longitude;
      this.$.satmap.latitude = marker.target.latitude;
      this.$.satmap.resize();

    }
  });
</script>
