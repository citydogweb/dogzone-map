<!--
@license
Copyright (c) 2016
Please feel free to use this element in any way you like.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../google-map/google-map.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../poly-filter/poly-filter-diacritic.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="dogzone-detail.html">

<!-- all used icons to not load full iconsets -->


<!--
An element providing a map of all dog parks in Vienna.

Example:

    <dogzone-map></dogzone-map>

@demo

-->
<dom-module id="dogzone-map">
  <template>
    <style is="custom-style">
      :host {
        position: relative;
        display: block;
        height: 100%;
      }

      #map {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }

      #infocontainer {
        position: absolute;
        width: 28%;
        right: 32px;
        top: 10%;
      }

      .flex-center-justified {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);

      }

      #inputBox {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);

        position: absolute;
        background-color: white;
        max-width: 600px;
        padding-left: 24px;
        padding-right: 24px;
        padding-bottom: 12px;
        left: 24px;
        top: 24px;
        border-radius: 2px;

      }
    </style>

    <iron-ajax auto url="http://data.wien.gv.at/daten/geo/" params='{"service":"WFS", "request":"getFeature", "version":"1.1.0", "typeName":"ogdwien:HUNDEZONEOGD", "srsName":"EPSG:4326", "outputFormat":"json"}' handleAs="json" on-response="_handleParks"></iron-ajax>
    <google-map id="map" disable-default-ui fit-to-markers click-events on-google-map-click="_handleMapClick" click-events>
      <template is="dom-repeat" items="[[filteredCoords]]" as="coord">
        <google-map-marker latitude="[[coord.geometry.coordinates.1]]" longitude="[[coord.geometry.coordinates.0]]" title="[[coord.properties.PARK]]" icon="[[parkIconUrl]]" on-google-map-marker-click="_handleMarkerClick" click-events>
        </google-map-marker>
      </template>
    </google-map>

    <poly-filter-diacritic filter="[[filterString]]" array-to-filter="[[coords]]" filtered-array="{{filteredCoords}}" filter-by="[]" filter-max-depth="1" logical-or="or">
    </poly-filter-diacritic>

    <paper-material elevation="4" id="inputBox">
      <paper-input id="parkFilterInput" label="Suche Park ..." value="{{filterString::input}}"></paper-input>
    </paper-material>

    <dogzone-detail id="infocontainer" name="[[selectedPark.properties.PARK]]" type="[[selectedPark.properties.TYP]]" size="[[selectedPark.properties.FLAECHE]]" longitude="[[selectedPark.geometry.coordinates.0]]" latitude="[[selectedPark.geometry.coordinates.1]]"
      hidden="true"></dogzone-detail>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'dogzone-map',
    properties: {

      /**
       * A custom icon path for map markers
       */
      parkIconUrl: {
        type: String,
        //value: 'dog_map_icon.png'
        value: 'https://raw.githubusercontent.com/citydogweb/dogzone-map/master/dog_map_icon.png'
          //value: 'map-iconset-svg:close'
      },

      /**
       * A Object of the currently selected park
       */
      selectedPark: Object,


      filterString: String,


      /**
       * Coordinates of dog parks
       */
      coords: Array,

      /**
       * Coordinates of filtered dog parks
       */
      filteredCoords: Array

    },

    ready: function() {},

    observers: [
      '_changedCoords(coords, filteredCoords)'
    ],

    _changedCoords: function(coords, filteredCoords) {
      console.log("filteredCoords" + filteredCoords[0]);
    },

    _handleParks: function(event, response) {
      this.coords = response.response.features;
    },

    _handleMapClick: function(event) {
      this.$.infocontainer.hidden = true;

    },

    _handleClose: function(event) {
      this.$.infocontainer.hidden = true;
    },

    _handleMarkerClick: function(marker) {
      //get index from marker and use it to get park-node from COORDS(ajax-response)
      this.selectedPark = this.filteredCoords[marker.model.__data__.index];
      this.$.infocontainer.hidden = false;

    }
  });
</script>
